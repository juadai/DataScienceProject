---
title: "Browsing_richness_modelling"
author: "Chayanit Jaroonsophonsak"
date: '2022-08-30'
output: word_document
---
# Import data
```{r}
rich_df = read.csv("/Users/tat/Documents/Data Science Sem 3/Project 2/Data/richness_calculation.csv")
head(rich_df)
```

# H: Removal of browsing will cause a greater increase in understorey species richness in T1 compared to T2 
## Visualisation
```{r}
#Year 0 to 3
rich_fenced_03=rich_df[rich_df$Time=="0-3" & rich_df$Quadrat_fenced=="True",]
plot(rich_fenced_03$Richness_change, xlab="16 fenced quadrats for each plot: 7, 9, 10, 12", ylab="change in species richness", main="Change in species richness from Y0 to Y3 after browsing exclusion", col=factor(rich_fenced_03$Treatment))
abline(h=0, lty=2)
legend("bottomright", legend = paste(c("T1","T2")), col=c("black","red"), pch=1)

boxplot(rich_fenced_03$Richness_change~rich_fenced_03$Treatment, xlab="Treatment", ylab="Change in species richness", main="Change in species richness from Y0 to Y3 after browsing exclusion")

hist(rich_fenced_03$Richness_change)

#Year 3 to 6
rich_fenced_36=rich_df[rich_df$Time=="3-6" & rich_df$Quadrat_fenced=="True",]
plot(rich_fenced_36$Richness_change, xlab="16 fenced quadrats for each plot: 7, 9, 10, 12", ylab="change in species richness", main="Change in species richness from Y3 to Y6 after browsing exclusion", col=factor(rich_fenced_36$Treatment))
abline(h=0, lty=2)
legend("bottomright", legend = paste(c("T1","T2")), col=c("black","red"), pch=1)

boxplot(rich_fenced_36$Richness_change~rich_fenced_36$Treatment, xlab="Treatment", ylab="Change in species richness", main="Change in species richness from Y3 to Y6 after browsing exclusion")

hist(rich_fenced_36$Richness_change)

#Year 0 to 6
rich_fenced_06=rich_df[rich_df$Time=="0-6" & rich_df$Quadrat_fenced=="True",]
plot(rich_fenced_06$Richness_change, xlab="16 fenced quadrats for each plot: 7, 9, 10, 12", ylab="change in species richness", main="Change in species richness from Y0 to Y6 after browsing exclusion", col=factor(rich_fenced_06$Treatment))
abline(h=0, lty=2)
legend("bottomright", legend = paste(c("T1","T2")), col=c("black","red"), pch=1)

boxplot(rich_fenced_06$Richness_change~rich_fenced_06$Treatment, xlab="Treatment", ylab="Change in species richness", main="Change in species richness from Y0 to Y6 after browsing exclusion")

hist(rich_fenced_06$Richness_change)
```

## Modelling
### Year 0 to 3 (Choose Negative Binomial GLM)
```{r}
#Linear model
rich_03_lm_a=lm(Richness_change~Treatment+Quadrat_gap, rich_fenced_03)
summary(rich_03_lm_a)
plot(rich_03_lm_a)
rich_03_lm_b=lm(Richness_change~Quadrat_gap, rich_fenced_03)
anova(rich_03_lm_b,rich_03_lm_a)
#Treatment is not significant
```

```{r}
#Poisson GLM
#manipulate data by adding a constant to every y, so that they are all non-negative
a=min(rich_fenced_03$Richness_change)
rich_fenced_03$Richness_change_pos=rich_fenced_03$Richness_change + abs(a)

#visualisation and test if the data is poisson
hist(rich_fenced_03$Richness_change_pos)
library(fitdistrplus)
poisson.model1=fitdist(rich_fenced_03$Richness_change_pos,"pois",method=c("mle"))
poisson.model1
poisson.lambda=13.85938

plot(poisson.model1)

n=length(rich_fenced_03$Richness_change_pos)
samp.pct <- (1:n-0.5)/n
qqplot(x=qpois(samp.pct,poisson.lambda), y=sort(rich_fenced_03$Richness_change_pos), xlab = 'Theoretical quantiles', ylab = 'Empirical quantiles', main='Q-Q plot Poisson')
abline(0,1,col="red")


#fit the model
library(boot)
rich_03_pois_a=glm(Richness_change_pos~Treatment+Quadrat_gap, rich_fenced_03, family = poisson)
summary(rich_03_pois_a)
glm.diag.plots((rich_03_pois_a))
rich_03_pois_b=glm(Richness_change_pos~Treatment, rich_fenced_03, family = poisson)
summary(rich_03_pois_b)
#goodness of fit
qchisq(0.95,61)
#not adequate
library(msme)
P__disp(rich_03_pois_b)
#dispersion is high (>1) 
```

```{r}
#Negative Binomial GLM
#Test if the data is Negative Binomial 
nbinom.model1=fitdist(rich_fenced_03$Richness_change_pos,"nbinom",method=c("mle"))
nbinom.model1
size.nbinom=17.38644		#first parameter	
mu.nbinom=13.85894
prob.nbinom=size.nbinom/(size.nbinom+mu.nbinom) 
prob.nbinom 

plot(nbinom.model1)
qqplot(x=qnbinom(samp.pct,size.nbinom,prob.nbinom), y=sort(rich_fenced_03$Richness_change_pos), xlab = 'Theoretical quantiles', ylab = 'Empirical quantiles', main='Q-Q plot Negative Binomial')
abline(0,1,col="red")
#looks better than Poisson

#fit the model
rich_03_nb_a=glm.nb(Richness_change_pos~Treatment+Quadrat_gap, rich_fenced_03)
summary(rich_03_nb_a)
rich_03_nb_b=glm.nb(Richness_change_pos~Treatment, rich_fenced_03)
summary(rich_03_nb_b) # choose this model
#goodness of fit
qchisq(0.95,61)
#adequate
#Treatment is not significant
```

# try incorporate random effects
```{r}
rich_03_nbmm_b=glmer.nb(Richness_change_pos~Treatment+(1|Plot_number/Quadrat_number), data=rich_fenced_03)
summary(rich_03_nbmm_b)

#test the significance of random effect
LRT = 2 * (-logLik(rich_03_nbmm_b)) - 2 * (-logLik(rich_03_nb_b)) 
LRT
pchisq(as.numeric(LRT), df=2, lower.tail=F)
#not significant
```

#Year 3 to 6 (Choose Negative Binomial GLM*)
```{r}
#Linear model
rich_36_lm_a=lm(Richness_change~Treatment+Quadrat_gap, rich_fenced_36)
summary(rich_36_lm_a)
plot(rich_36_lm_a)

rich_36_lm_b=lm(Richness_change~Quadrat_gap, rich_fenced_36)
anova(rich_36_lm_b,rich_36_lm_a)
#Treatment is not significant
```

```{r}
#Poisson GLM
#manipulate data by adding a constant to every y, so that they are all non-negative
b=min(rich_fenced_36$Richness_change)
rich_fenced_36$Richness_change_pos=rich_fenced_36$Richness_change + abs(b)

#visualisation and test if the data is poisson
hist(rich_fenced_36$Richness_change_pos)
poisson.model2=fitdist(rich_fenced_36$Richness_change_pos,"pois",method=c("mle"))
poisson.model2
poisson.lambda2=12.23438	

plot(poisson.model2)

n2=length(rich_fenced_36$Richness_change_pos)
samp.pct2 <- (1:n2-0.5)/n2
qqplot(x=qpois(samp.pct2,poisson.lambda2), y=sort(rich_fenced_36$Richness_change_pos), xlab = 'Theoretical quantiles', ylab = 'Empirical quantiles', main='Q-Q plot Poisson')
abline(0,1,col="red")
#data has heavier tails than Poisson

#fit the model
rich_36_pois_a=glm(Richness_change_pos~Treatment+Quadrat_gap, rich_fenced_36, family = poisson)
summary(rich_36_pois_a)
rich_36_pois_b=glm(Richness_change_pos~Treatment, rich_fenced_36, family = poisson)
summary(rich_36_pois_b)
#goodness of fit
qchisq(0.95,61)
#not adequate
P__disp(rich_36_pois_b)
#very high dispersion (>1)
```

```{r}
#Negative Binomial GLM
#Test if the data is Negative Binomial 
nbinom.model2=fitdist(rich_fenced_36$Richness_change_pos,"nbinom",method=c("mle"))
nbinom.model2
size.nbinom2=7.670044		#first parameter	
mu.nbinom2=12.233783	
prob.nbinom2=size.nbinom2/(size.nbinom2+mu.nbinom2) 
prob.nbinom2 

plot(nbinom.model2)
qqplot(x=qnbinom(samp.pct2,size.nbinom2,prob.nbinom2), y=sort(rich_fenced_36$Richness_change_pos), xlab = 'Theoretical quantiles', ylab = 'Empirical quantiles', main='Q-Q plot Negative Binomial')
abline(0,1,col="red")
#better than Poisson, but is it good enough (?)

#fit the model
rich_36_nb_a=glm.nb(Richness_change_pos~Treatment+Quadrat_gap, rich_fenced_36)
summary(rich_36_nb_a) 
rich_36_nb_b=glm.nb(Richness_change_pos~Treatment, rich_fenced_36)
summary(rich_36_nb_b) #choose this model*
#goodness of fit
qchisq(0.95,62)
#Adequate
#Treatment is not significant
glm.diag.plots((rich_36_nb_a))
#heavy left tail
```

# try incorporate random effects
```{r}
rich_36_nbmm_b=glmer.nb(Richness_change_pos~Treatment+(1|Plot_number/Quadrat_number), data=rich_fenced_36)
summary(rich_36_nbmm_b)

#test the significance of random effect
LRT = 2 * (-logLik(rich_36_nbmm_b)) - 2 * (-logLik(rich_36_nb_b))
LRT
pchisq(as.numeric(LRT), df=2, lower.tail=F)
#not significant
```

#Year 0 to 6 (Choose Negative Binomial GLM*)
```{r}
#Linear model
rich_06_lm_a=lm(Richness_change~Treatment+Quadrat_gap, rich_fenced_06)
summary(rich_06_lm_a)
plot(rich_06_lm_a)

rich_06_lm_b=lm(Richness_change~Treatment, rich_fenced_06)
summary(rich_06_lm_b)
#Treatment is not significant
```

```{r}
#Poisson GLM
#manipulate data by adding a constant to every y, so that they are all non-negative
c=min(rich_fenced_06$Richness_change)
rich_fenced_06$Richness_change_pos=rich_fenced_06$Richness_change + abs(c)

#visualisation and test if the data is poisson
hist(rich_fenced_06$Richness_change_pos)
poisson.model3=fitdist(rich_fenced_06$Richness_change_pos,"pois",method=c("mle"))
poisson.model3
poisson.lambda3=10.09375		

plot(poisson.model3)

n3=length(rich_fenced_06$Richness_change_pos)
samp.pct3 <- (1:n3-0.5)/n3
qqplot(x=qpois(samp.pct3,poisson.lambda3), y=sort(rich_fenced_06$Richness_change_pos), xlab = 'Theoretical quantiles', ylab = 'Empirical quantiles', main='Q-Q plot Poisson')
abline(0,1,col="red")
#data has heavier tail than poisson

#fit the model
rich_06_pois_a=glm(Richness_change_pos~ Treatment + Quadrat_gap, rich_fenced_06, family = poisson)
summary(rich_06_pois_a)
rich_06_pois_b=glm(Richness_change_pos~Treatment, rich_fenced_06, family = poisson)
summary(rich_06_pois_b)
#goodness of fit
qchisq(0.95,62)
#not adequate
P__disp(rich_06_pois_b)
#very high dispersion (>1)
```

```{r}
#Negative Binomial GLM
#Test if the data is Negative Binomial 
nbinom.model3=fitdist(rich_fenced_06$Richness_change_pos,"nbinom",method=c("mle"))
nbinom.model3
size.nbinom3=7.502305			#first parameter	
mu.nbinom3=10.093805
prob.nbinom3=size.nbinom3/(size.nbinom3+mu.nbinom3) 
prob.nbinom3 

plot(nbinom.model3)
qqplot(x=qnbinom(samp.pct3,size.nbinom3,prob.nbinom3), y=sort(rich_fenced_06$Richness_change_pos), xlab = 'Theoretical quantiles', ylab = 'Empirical quantiles', main='Q-Q plot Negative Binomial')
abline(0,1,col="red")
#looks moderately good

#fit the model
rich_06_nb_a=glm.nb(Richness_change_pos~Treatment+Quadrat_gap, rich_fenced_06)
summary(rich_06_nb_a)
rich_06_nb_b=glm.nb(Richness_change_pos~Treatment, rich_fenced_06)
summary(rich_06_nb_b) #choose this model
#goodness of fit
qchisq(0.95,62)
#Adequate
#Treatment is not significant
glm.diag.plots((rich_06_nb_b))
#Heavy left tail
```

# try incorporate random effects
```{r}
rich_06_nbmm_b=glmer.nb(Richness_change_pos~Treatment+(1|Plot_number/Quadrat_number), data=rich_fenced_06)
summary(rich_06_nbmm_b)

#test the significance of random effect
LRT = 2 * (-logLik(rich_06_nbmm_b)) - 2 * (-logLik(rich_06_nb_b))
LRT
pchisq(as.numeric(LRT), df=2, lower.tail=F)
#not significant
```

# H: Removal of Browsing will cause Species richness to be higher across all treatments (T1 & T2)
## Visualisation
```{r}
#Year 0 to 3
rich_03_df=rich_df[rich_df$Time=="0-3",]
plot(rich_03_df$Richness_change, xlab="32 quadrats for each plot: 7, 9, 10, 12", ylab="change in species richness", main="Change in species richness in fenced and unfenced quadrats from Y0 to Y3 ", col=factor(rich_03_df$Quadrat_fenced))
abline(h=0, lty=2)
legend("bottomright", legend = paste(c("unfenced","fenced")), col=c("black","red"), pch=1)

boxplot(rich_03_df$Richness_change~rich_03_df$Quadrat_fenced, xlab="Fenced quadrat?", ylab="Change in species richness", main="Change in species richness from Y0 to Y3")

library(ggplot2)
ggplot(rich_03_df, aes(x=Richness_change, color=Quadrat_fenced)) + geom_histogram(fill="white", position="dodge") + theme(legend.position="top")

#Year 3 to 6
rich_36_df=rich_df[rich_df$Time=="3-6",]
plot(rich_36_df$Richness_change, xlab="32 quadrats for each plot: 7, 9, 10, 12", ylab="change in species richness", main="Change in species richness in fenced and unfenced quadrats from Y3 to Y6 ", col=factor(rich_36_df$Quadrat_fenced))
abline(h=0, lty=2)
legend("bottomright", legend = paste(c("unfenced","fenced")), col=c("black","red"), pch=1)

boxplot(rich_36_df$Richness_change~rich_36_df$Quadrat_fenced, xlab="Fenced quadrat?", ylab="Change in species richness", main="Change in species richness from Y3 to Y6")

ggplot(rich_36_df, aes(x=Richness_change, color=Quadrat_fenced)) + geom_histogram(fill="white", position="dodge") + theme(legend.position="top")

#Year 0 to 6
rich_06_df=rich_df[rich_df$Time=="0-6",]
plot(rich_06_df$Richness_change, xlab="32 quadrats for each plot: 7, 9, 10, 12", ylab="change in species richness", main="Change in species richness in fenced and unfenced quadrats from Y0 to Y6 ", col=factor(rich_06_df$Quadrat_fenced))
abline(h=0, lty=2)
legend("bottomright", legend = paste(c("unfenced","fenced")), col=c("black","red"), pch=1)

boxplot(rich_06_df$Richness_change~rich_06_df$Quadrat_fenced, xlab="Fenced quadrat?", ylab="Change in species richness", main="Change in species richness from Y0 to Y6")

ggplot(rich_06_df, aes(x=Richness_change, color=Quadrat_fenced)) + geom_histogram(fill="white", position="dodge") + theme(legend.position="top")
```

## Modelling 

### Y0 to 3 (choose Negative Binomial GLM)
```{r}
# Linear model
rich_03_lm_h2a=lm(Richness_change~Quadrat_fenced+Treatment+Quadrat_gap,data=rich_03_df)
summary(rich_03_lm_h2a)
plot(rich_03_lm_h2a)

rich_03_lm_h2b=lm(Richness_change~Quadrat_fenced+Treatment,rich_03_df)
summary(rich_03_lm_h2b)
plot(rich_03_lm_h2b)
anova(rich_03_lm_h2b,rich_03_lm_h2a)

rich_03_lm_h2c=lm(Richness_change~Treatment,rich_03_df)
summary(rich_03_lm_h2c)
plot(rich_03_lm_h2c)
anova(rich_03_lm_h2c,rich_03_lm_h2b)
#Quadrat_fenced is not significant
```

```{r}
#Poisson GLM
#manipulate data by adding a constant to every y, so that they are all non-negative
z=min(rich_03_df$Richness_change)
rich_03_df$Richness_change_pos=rich_03_df$Richness_change + abs(z)

#visualisation and test if the data is poisson
hist(rich_03_df$Richness_change_pos)
poisson.model4=fitdist(rich_03_df$Richness_change_pos,"pois",method=c("mle"))
poisson.model4
poisson.lambda4=13.97656

plot(poisson.model4)

n4=length(rich_03_df$Richness_change_pos)
samp.pct4 <- (1:n4-0.5)/n4
qqplot(x=qpois(samp.pct4,poisson.lambda4), y=sort(rich_03_df$Richness_change_pos), xlab = 'Theoretical quantiles', ylab = 'Empirical quantiles', main='Q-Q plot Poisson')
abline(0,1,col="red")
#data has heavier tails than Poisson

#fit the model
rich_03_pois_h2a=glm(Richness_change_pos~Quadrat_fenced+Treatment+Quadrat_gap, rich_03_df, family = poisson)
summary(rich_03_pois_h2a)
#goodness of fit
qchisq(0.95,124)
#inadequate
P__disp(rich_03_pois_h2a)

rich_03_pois_h2b=glm(Richness_change_pos~Treatment+Quadrat_gap, rich_03_df, family = poisson)
summary(rich_03_pois_h2b) #choose this
#goodness of fit
qchisq(0.95,125)
#inadequate

anova(rich_03_pois_h2b,rich_03_pois_h2a)
qchisq(0.95,1)
# Quadrat_fenced is not significant
```

```{r}
#Negative Binomial GLM
#Test if the data is Negative Binomial 
nbinom.model4=fitdist(rich_03_df$Richness_change_pos,"nbinom",method=c("mle"))
nbinom.model4
size.nbinom4=15.42857				#first parameter	
mu.nbinom4=13.97705
prob.nbinom4=size.nbinom4/(size.nbinom4+mu.nbinom4) 
prob.nbinom4

plot(nbinom.model4)
qqplot(x=qnbinom(samp.pct4,size.nbinom4,prob.nbinom4), y=sort(rich_03_df$Richness_change_pos), xlab = 'Theoretical quantiles', ylab = 'Empirical quantiles', main='Q-Q plot Negative Binomial')
abline(0,1,col="red")
#look ok

#fit the model
rich_03_nb_h2a=glm.nb(Richness_change_pos~Quadrat_fenced+Treatment+Quadrat_gap, rich_03_df)
summary(rich_03_nb_h2a)
#goodness of fit
qchisq(0.95,124)
#Adequate

rich_03_nb_h2b=glm.nb(Richness_change_pos~Quadrat_fenced+Treatment, rich_03_df)
summary(rich_03_nb_h2b) #choose this model
#goodness of fit
qchisq(0.95,125)
#Adequate
anova(rich_03_nb_h2b,rich_03_nb_h2a)

rich_03_nb_h2c=glm.nb(Richness_change_pos~Treatment, rich_03_df)
summary(rich_03_nb_h2c)
#goodness of fit
qchisq(0.95,126)
#Adequate
anova(rich_03_nb_h2c,rich_03_nb_h2b)
#Quadrat_fenced is not significant
```

# try incorporate random effects
```{r}
rich_03_nbmm_h2b=glmer.nb(Richness_change_pos~Quadrat_fenced+Treatment+(1|Plot_number/Quadrat_number), data=rich_03_df)
summary(rich_03_nbmm_h2b)

#test the significance of random effect
LRT = 2 * (-logLik(rich_03_nbmm_h2b)) - 2 * (-logLik(rich_03_nb_h2b))
LRT
pchisq(as.numeric(LRT), df=2, lower.tail=F)
#not significant
```

### Y3 to 6 (Choose Negative Binomial GLM*)
```{r}
# Linear model
rich_36_lm_h2a=lm(Richness_change~Quadrat_fenced+Treatment+Quadrat_gap,data=rich_36_df)
summary(rich_36_lm_h2a)
plot(rich_36_lm_h2a)

rich_36_lm_h2b=lm(Richness_change~Quadrat_fenced+Quadrat_gap,rich_36_df)
summary(rich_36_lm_h2b)
plot(rich_36_lm_h2b)
anova(rich_36_lm_h2b,rich_36_lm_h2a)

rich_36_lm_h2c=lm(Richness_change~Quadrat_gap,rich_36_df)
summary(rich_36_lm_h2c)
plot(rich_36_lm_h2c)
anova(rich_36_lm_h2c,rich_36_lm_h2b)

#Quadrat_fenced is not significant
```

```{r}
#Poisson GLM
#manipulate data by adding a constant to every y, so that they are all non-negative
w=min(rich_36_df$Richness_change)
rich_36_df$Richness_change_pos=rich_36_df$Richness_change + abs(w)

#visualisation and test if the data is poisson
hist(rich_36_df$Richness_change_pos)
poisson.model5=fitdist(rich_36_df$Richness_change_pos,"pois",method=c("mle"))
poisson.model5
poisson.lambda5=12.42969	

plot(poisson.model5)

n5=length(rich_36_df$Richness_change_pos)
samp.pct5 <- (1:n5-0.5)/n5
qqplot(x=qpois(samp.pct5,poisson.lambda5), y=sort(rich_36_df$Richness_change_pos), xlab = 'Theoretical quantiles', ylab = 'Empirical quantiles', main='Q-Q plot Poisson')
abline(0,1,col="red")

#fit the model
rich_36_pois_h2a=glm(Richness_change_pos~Quadrat_fenced+Treatment+Quadrat_gap, rich_36_df, family = poisson)
summary(rich_36_pois_h2a)
#goodness of fit
qchisq(0.95,124)
#inadequate

rich_36_pois_h2b=glm(Richness_change_pos~Quadrat_fenced+Quadrat_gap, rich_36_df, family = poisson)
summary(rich_36_pois_h2b)
#goodness of fit
qchisq(0.95,125)
#inadequate
P__disp(rich_36_pois_h2b)
#high dispersion

rich_36_pois_h2c=glm(Richness_change_pos~Quadrat_gap, rich_36_df, family = poisson)
summary(rich_36_pois_h2c)
#goodness of fit
qchisq(0.95,125)
#inadequate

anova(rich_36_pois_h2c,rich_36_pois_h2b)
qchisq(0.95,1)
# Quadrat_fenced is not significant
```

```{r}
#Negative Binomial GLM
#Test if the data is Negative Binomial 
nbinom.model5=fitdist(rich_36_df$Richness_change_pos,"nbinom",method=c("mle"))
nbinom.model5
size.nbinom5=12.66537				#first parameter	
mu.nbinom5=12.43057
prob.nbinom5=size.nbinom5/(size.nbinom5+mu.nbinom5) 
prob.nbinom5

plot(nbinom.model5)
qqplot(x=qnbinom(samp.pct5,size.nbinom5,prob.nbinom5), y=sort(rich_36_df$Richness_change_pos), xlab = 'Theoretical quantiles', ylab = 'Empirical quantiles', main='Q-Q plot Negative Binomial')
abline(0,1,col="red")
#looks ok, but is it good enough?

#fit the model
rich_36_nb_h2a=glm.nb(Richness_change_pos~Quadrat_fenced+Treatment+Quadrat_gap, rich_36_df)
summary(rich_36_nb_h2a)
#goodness of fit
qchisq(0.95,124)
#Adequate

rich_36_nb_h2b=glm.nb(Richness_change_pos~Quadrat_fenced+Quadrat_gap, rich_36_df)
summary(rich_36_nb_h2b) #choose this
#goodness of fit
qchisq(0.95,125)
#Adequate

rich_36_nb_h2c=glm.nb(Richness_change_pos~Quadrat_gap, rich_36_df)
summary(rich_36_nb_h2c)
#goodness of fit
qchisq(0.95,126)
#Adequate
anova(rich_36_nb_h2c,rich_36_nb_h2b)
#Quadrat_fenced is not significant
glm.diag.plots((rich_36_nb_h2b))
#heavy left tail
```

# try incorporate random effects
```{r}
rich_36_nbmm_h2b=glmer.nb(Richness_change_pos~Quadrat_fenced+Quadrat_gap+(1|Plot_number/Quadrat_number), data=rich_36_df)
summary(rich_36_nbmm_h2b)

#test the significance of random effect
LRT = 2 * (-logLik(rich_36_nbmm_h2b)) - 2 * (-logLik(rich_36_nb_h2b))
LRT
pchisq(as.numeric(LRT), df=2, lower.tail=F)
#not significant
```

### Y0 to 6 (Choose Negative Binomial GLM*)
```{r}
# Linear model
rich_06_lm_h2a=lm(Richness_change~Quadrat_fenced+Treatment+Quadrat_gap,data=rich_06_df)
summary(rich_06_lm_h2a)
plot(rich_06_lm_h2a)

rich_06_lm_h2b=lm(Richness_change~Quadrat_fenced+Treatment,rich_06_df)
summary(rich_06_lm_h2b)
plot(rich_06_lm_h2b)
anova(rich_06_lm_h2b,rich_06_lm_h2a)

rich_06_lm_h2c=lm(Richness_change~Treatment,rich_06_df)
summary(rich_06_lm_h2c)
plot(rich_06_lm_h2c)
anova(rich_06_lm_h2c,rich_06_lm_h2b)

#Quadrat_fenced is not significant
```

```{r}
#Poisson GLM
#manipulate data by adding a constant to every y, so that they are all non-negative
q=min(rich_06_df$Richness_change)
rich_06_df$Richness_change_pos=rich_06_df$Richness_change + abs(q)

#visualisation and test if the data is poisson
hist(rich_06_df$Richness_change_pos)
poisson.model6=fitdist(rich_06_df$Richness_change_pos,"pois",method=c("mle"))
poisson.model6
poisson.lambda6=13.40625		

plot(poisson.model6)

n6=length(rich_06_df$Richness_change_pos)
samp.pct6 <- (1:n6-0.5)/n6
qqplot(x=qpois(samp.pct6,poisson.lambda6), y=sort(rich_06_df$Richness_change_pos), xlab = 'Theoretical quantiles', ylab = 'Empirical quantiles', main='Q-Q plot Poisson')
abline(0,1,col="red")
#looking ok

#fit the model
rich_06_pois_h2a=glm(Richness_change_pos~Quadrat_fenced+Treatment+Quadrat_gap, rich_06_df, family = poisson)
summary(rich_06_pois_h2a)
#goodness of fit
qchisq(0.95,124)
#not adequate


rich_06_pois_h2b=glm(Richness_change_pos~Quadrat_fenced+Treatment, rich_06_df, family = poisson)
summary(rich_06_pois_h2b) 
#goodness of fit
qchisq(0.95,125)
#not adequate
P__disp(rich_36_pois_h2b)
#high dispersion

rich_06_pois_h2c=glm(Richness_change_pos~Treatment, rich_06_df, family = poisson)
summary(rich_06_pois_h2c)
#goodness of fit
qchisq(0.95,126)
#not adequate

anova(rich_06_pois_h2c,rich_06_pois_h2b)
qchisq(0.95,1)
# None of the models are adequate
# Quadrat_fenced is not significant
```

```{r}
#Negative Binomial GLM
#Test if the data is Negative Binomial 
nbinom.model6=fitdist(rich_06_df$Richness_change_pos,"nbinom",method=c("mle"))
nbinom.model6
size.nbinom6=25.75613					#first parameter	
mu.nbinom6=13.40744	
prob.nbinom6=size.nbinom6/(size.nbinom6+mu.nbinom6) 
prob.nbinom6

plot(nbinom.model6)
qqplot(x=qnbinom(samp.pct6,size.nbinom6,prob.nbinom6), y=sort(rich_06_df$Richness_change_pos), xlab = 'Theoretical quantiles', ylab = 'Empirical quantiles', main='Q-Q plot Negative Binomial')
abline(0,1,col="red")
#looks better than Poisson

#fit the model
rich_06_nb_h2a=glm.nb(Richness_change_pos~Quadrat_fenced+Treatment+Quadrat_gap, rich_06_df)
summary(rich_06_nb_h2a)
#goodness of fit
qchisq(0.95,124)
#Adequate

rich_06_nb_h2b=glm.nb(Richness_change_pos~Quadrat_fenced+Treatment, rich_06_df)
summary(rich_06_nb_h2b) #choose this
#goodness of fit
qchisq(0.95,125)
#Adequate

rich_06_nb_h2c=glm.nb(Richness_change_pos~Treatment, rich_06_df)
summary(rich_06_nb_h2c)
#goodness of fit
qchisq(0.95,126)
#Adequate
anova(rich_06_nb_h2c,rich_06_nb_h2b)
#Quadrat_fenced is not significant
glm.diag.plots((rich_06_nb_h2b))
#heavy left tail
```

# try incorporate random effects
```{r}
rich_06_nbmm_h2b=glmer.nb(Richness_change_pos~Quadrat_fenced+Treatment+(1|Plot_number/Quadrat_number), data=rich_06_df)
summary(rich_06_nbmm_h2b)

#test the significance of random effect
LRT = 2 * (-logLik(rich_06_nbmm_h2b)) - 2 * (-logLik(rich_06_nb_h2b))
LRT
pchisq(as.numeric(LRT), df=2, lower.tail=F)
#not significant
```
