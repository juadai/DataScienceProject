---
title: "Browsing exclusion_modelling_newdata_someplantsremoved"
author: "Chayanit Jaroonsophonsak"
date: "27/07/2022"
output: word_document
---

Note: Only plots 7(T2), 9(T2), 10(T1), and 12(T1) have fenced quadrats. 
So, we are only able to test the effect of browsing exclusion between these 2 treatments, but not the control

Note2: even quadrats are fenced, odd quadrats are unfenced 

Current issues:
1. Diversity Modelling for (Y3-6) & (Y0-6)
Linear model fit the data moderately good, but not great. Data seems to have lighter tails than Normal distribution. Want to try using Beta GLM but don't know how to transform the data into between [0,1] 
Tried using percentage change instead, but also had to solve the negative values issue. After adding a constant throughout, some points become greater than 1 -> still can't fit beta

# Import data
```{r}
data=read.csv("joined_understorey_observations.csv")
head(data)
focused_data=data[data$Plot_number %in% c(7,9,10,12),]#only retain data from plots 7,9,10,12
focused_data=focused_data[!(focused_data$T002_Flora_Species_name=='Dead Standing Timber' | focused_data$T002_Flora_Species_name=='Standing dead timber' | focused_data$T002_Flora_Species_name=='Oxalis sp 2.' | focused_data$T002_Flora_Species_name=='Oxalis (native)' | focused_data$T002_Flora_Species_name=='Oxalis sp (weed)' | focused_data$T002_Flora_Species_name=='MoSs/Lichen'),] #remove some inter-tussock plants

Y0_data=focused_data[focused_data$Year_monitoring==0,]
Y3_data=focused_data[focused_data$Year_monitoring==3,]
Y6_data=focused_data[focused_data$Year_monitoring==6,]
```

# Species richness
```{r}
#calculate species richness in each quadrat each year 
library(dplyr)
Y0_rich=c()
for (i in c(7,9,10,12))
  {for (j in seq(1,32,1))
    {dataset=Y0_data[Y0_data$Plot_number==i & Y0_data$Quadrat_number==j,]
    count_scientifname <- dataset %>% count(Scientific.Name)
    a=nrow(count_scientifname)
    Y0_rich=append(Y0_rich,a)
  }
}
Y0_rich

Y3_rich=c()
for (i in c(7,9,10,12))
  {for (j in seq(1,32,1))
    {dataset=Y3_data[Y3_data$Plot_number==i & Y3_data$Quadrat_number==j,]
    count_scientifname <- dataset %>% count(Scientific.Name)
    a=nrow(count_scientifname)
    Y3_rich=append(Y3_rich,a)
  }
}
Y3_rich

Y6_rich=c()
for (i in c(7,9,10,12))
  {for (j in seq(1,32,1))
    {dataset=Y6_data[Y6_data$Plot_number==i & Y6_data$Quadrat_number==j,]
    count_scientifname <- dataset %>% count(Scientific.Name)
    a=nrow(count_scientifname) 
    Y6_rich=append(Y6_rich,a)
  }
}
Y6_rich

#Calculate changes in species richness
Y03_rich=Y3_rich-Y0_rich 
Y03_rich 

Y36_rich=Y6_rich-Y3_rich
Y36_rich 

Y06_rich=Y6_rich-Y0_rich
Y06_rich

#Extract in gap/ out of gap information
Quadrat_gap={}
for (i in c(7,9,10,12)){
  for (j in seq(1,32,1)){
    gap=toString(unique(Y0_data[Y0_data$Plot_number==i & Y0_data$Quadrat_number==j,]$Quadrat_gap))
    Quadrat_gap=append(Quadrat_gap,gap)
  }
}
Quadrat_gap
length(Quadrat_gap)


#Generate a dataframe for the changes in species richness 
Time=rep(c('0-3','3-6','0-6'),c(128,128,128))
Plot_number=rep(rep(c(7,9,10,12),c(32,32,32,32)),3)
Treatment=rep(rep(c("Radial","Gap"),c(64,64)),3)
Quadrat_number=rep(seq(1,32,1),12)
Quadrat_fenced=rep(c('False','True'),192)
Quadrat_gap=rep(Quadrat_gap,3)
Richness_change=c(Y03_rich,Y36_rich, Y06_rich)
rich_df=data.frame(Time, Plot_number, Treatment, Quadrat_number, Quadrat_fenced, Quadrat_gap, Richness_change)
```

# H: Removal of browsing will cause a greater increase in understorey species richness in T1 compared to T2 
## Visualisation
```{r}
#Year 0 to 3
rich_fenced_03=rich_df[rich_df$Time=="0-3" & Quadrat_fenced=="True",]
plot(rich_fenced_03$Richness_change, xlab="16 fenced quadrats for each plot: 7, 9, 10, 12", ylab="change in species richness", main="Change in species richness from Y0 to Y3 after browsing exclusion", col=factor(rich_fenced_03$Treatment))
abline(h=0, lty=2)
legend("bottomright", legend = paste(c("T1","T2")), col=c("black","red"), pch=1)

boxplot(rich_fenced_03$Richness_change~rich_fenced_03$Treatment, xlab="Treatment", ylab="Change in species richness", main="Change in species richness from Y0 to Y3 after browsing exclusion")

hist(rich_fenced_03$Richness_change)

#Year 3 to 6
rich_fenced_36=rich_df[rich_df$Time=="3-6" & Quadrat_fenced=="True",]
plot(rich_fenced_36$Richness_change, xlab="16 fenced quadrats for each plot: 7, 9, 10, 12", ylab="change in species richness", main="Change in species richness from Y3 to Y6 after browsing exclusion", col=factor(rich_fenced_36$Treatment))
abline(h=0, lty=2)
legend("bottomright", legend = paste(c("T1","T2")), col=c("black","red"), pch=1)

boxplot(rich_fenced_36$Richness_change~rich_fenced_36$Treatment, xlab="Treatment", ylab="Change in species richness", main="Change in species richness from Y3 to Y6 after browsing exclusion")

hist(rich_fenced_36$Richness_change)

#Year 0 to 6
rich_fenced_06=rich_df[rich_df$Time=="0-6" & Quadrat_fenced=="True",]
plot(rich_fenced_06$Richness_change, xlab="16 fenced quadrats for each plot: 7, 9, 10, 12", ylab="change in species richness", main="Change in species richness from Y0 to Y6 after browsing exclusion", col=factor(rich_fenced_06$Treatment))
abline(h=0, lty=2)
legend("bottomright", legend = paste(c("T1","T2")), col=c("black","red"), pch=1)

boxplot(rich_fenced_06$Richness_change~rich_fenced_06$Treatment, xlab="Treatment", ylab="Change in species richness", main="Change in species richness from Y0 to Y6 after browsing exclusion")

hist(rich_fenced_06$Richness_change)
```

## Modelling
### Year 0 to 3 (Choose Poisson)
```{r}
#Linear model
rich_03_lm=lm(Richness_change~Treatment+Quadrat_gap, rich_fenced_03)
summary(rich_03_lm)
plot(rich_03_lm)
rich_03_lm2=lm(Richness_change~Quadrat_gap, rich_fenced_03)
anova(rich_03_lm2,rich_03_lm)
```

```{r}
#Poisson GLM
#manipulate data by adding a constant to every y, so that they are all non-negative
a=min(rich_fenced_03$Richness_change)
rich_fenced_03$Richness_change_pos=rich_fenced_03$Richness_change + abs(a)
hist(rich_fenced_03$Richness_change_pos)

#visualisation and test if the data is poisson
hist(rich_fenced_03$Richness_change_pos)
library(fitdistrplus)
poisson.model1=fitdist(rich_fenced_03$Richness_change_pos,"pois",method=c("mle"))
poisson.model1
poisson.lambda=4.765625

plot(poisson.model1)

n=length(rich_fenced_03$Richness_change_pos)
samp.pct <- (1:n-0.5)/n
qqplot(x=qpois(samp.pct,poisson.lambda), y=sort(rich_fenced_03$Richness_change_pos), xlab = 'Theoretical quantiles', ylab = 'Empirical quantiles', main='Q-Q plot Poisson')
abline(0,1,col="red")


#fit the model
rich_03_pois=glm(Richness_change_pos~Treatment+Quadrat_gap, rich_fenced_03, family = poisson)
summary(rich_03_pois)
#goodness of fit
qchisq(0.95,61)
library(msme)
P__disp(rich_03_pois)
#adequate
```

```{r}
#Negative Binomial GLM
#Test if the data is Negative Binomial 
nbinom.model1=fitdist(rich_fenced_03$Richness_change_pos,"nbinom",method=c("mle"))
nbinom.model1
size.nbinom=296.780480		#first parameter	
mu.nbinom=4.765749
prob.nbinom=size.nbinom/(size.nbinom+mu.nbinom) 
prob.nbinom 

plot(nbinom.model1)
qqplot(x=qnbinom(samp.pct,size.nbinom,prob.nbinom), y=sort(rich_fenced_03$Richness_change_pos), xlab = 'Theoretical quantiles', ylab = 'Empirical quantiles', main='Q-Q plot Negative Binomial')
abline(0,1,col="red")

#fit the model
rich_03_nb=glm.nb(Richness_change_pos~Treatment+Quadrat_gap, rich_fenced_03)
summary(rich_03_nb)
#goodness of fit
qchisq(0.95,61)
#Adequate
```

#Year 3 to 6 (Choose Poisson)
```{r}
#Linear model
rich_36_lm=lm(Richness_change~Treatment+Quadrat_gap, rich_fenced_36)
summary(rich_36_lm)
plot(rich_36_lm)

rich_36_lm2=lm(Richness_change~Quadrat_gap, rich_fenced_36)
anova(rich_36_lm2,rich_36_lm)
```

```{r}
#Poisson GLM
#manipulate data by adding a constant to every y, so that they are all non-negative
b=min(rich_fenced_36$Richness_change)
rich_fenced_36$Richness_change_pos=rich_fenced_36$Richness_change + abs(b)

#visualisation and test if the data is poisson
hist(rich_fenced_36$Richness_change_pos)
poisson.model2=fitdist(rich_fenced_36$Richness_change_pos,"pois",method=c("mle"))
poisson.model2
poisson.lambda2=6.328125

plot(poisson.model2)

n2=length(rich_fenced_36$Richness_change_pos)
samp.pct2 <- (1:n2-0.5)/n2
qqplot(x=qpois(samp.pct2,poisson.lambda2), y=sort(rich_fenced_36$Richness_change_pos), xlab = 'Theoretical quantiles', ylab = 'Empirical quantiles', main='Q-Q plot Poisson')
abline(0,1,col="red")


#fit the model
rich_36_pois=glm(Richness_change_pos~Treatment+Quadrat_gap, rich_fenced_36, family = poisson)
summary(rich_36_pois)
#goodness of fit
qchisq(0.95,61)
#adequate
P__disp(rich_36_pois)
```

```{r}
#Negative Binomial GLM
#Test if the data is Negative Binomial 
nbinom.model2=fitdist(rich_fenced_36$Richness_change_pos,"nbinom",method=c("mle"))
nbinom.model2
size.nbinom2=22.142529	#first parameter	
mu.nbinom2=6.328383	
prob.nbinom2=size.nbinom2/(size.nbinom2+mu.nbinom2) 
prob.nbinom2 

plot(nbinom.model2)
qqplot(x=qnbinom(samp.pct2,size.nbinom2,prob.nbinom2), y=sort(rich_fenced_36$Richness_change_pos), xlab = 'Theoretical quantiles', ylab = 'Empirical quantiles', main='Q-Q plot Negative Binomial')
abline(0,1,col="red")
#better than Poisson, but is it good enough (?)

#fit the model
rich_36_nb=glm.nb(Richness_change_pos~Treatment+Quadrat_gap, rich_fenced_36)
summary(rich_36_nb)
#goodness of fit
qchisq(0.95,61)
#Adequate
```

#Year 0 to 6 (Choose negative binomial)
```{r}
#Linear model
rich_06_lm=lm(Richness_change~Treatment, rich_fenced_06)
summary(rich_06_lm)
plot(rich_06_lm)

rich_06_lm2=lm(Richness_change~1, rich_fenced_06)
anova(rich_06_lm2,rich_06_lm)
```

```{r}
#Poisson GLM
#manipulate data by adding a constant to every y, so that they are all non-negative
c=min(rich_fenced_06$Richness_change)
rich_fenced_06$Richness_change_pos=rich_fenced_06$Richness_change + abs(c)

#visualisation and test if the data is poisson
hist(rich_fenced_06$Richness_change_pos)
poisson.model3=fitdist(rich_fenced_06$Richness_change_pos,"pois",method=c("mle"))
poisson.model3
poisson.lambda3=5.09375	

plot(poisson.model3)

n3=length(rich_fenced_06$Richness_change_pos)
samp.pct3 <- (1:n3-0.5)/n3
qqplot(x=qpois(samp.pct3,poisson.lambda3), y=sort(rich_fenced_06$Richness_change_pos), xlab = 'Theoretical quantiles', ylab = 'Empirical quantiles', main='Q-Q plot Poisson')
abline(0,1,col="red")

#fit the model
rich_06_pois=glm(Richness_change_pos~Treatment, rich_fenced_06, family = poisson)
summary(rich_06_pois)
#goodness of fit
qchisq(0.95,61)
#not adequate
P__disp(rich_06_pois)
```

```{r}
#Negative Binomial GLM
#Test if the data is Negative Binomial 
nbinom.model3=fitdist(rich_fenced_06$Richness_change_pos,"nbinom",method=c("mle"))
nbinom.model3
size.nbinom3=11.755922			#first parameter	
mu.nbinom3=5.093354	
prob.nbinom3=size.nbinom3/(size.nbinom3+mu.nbinom3) 
prob.nbinom3 

plot(nbinom.model3)
qqplot(x=qnbinom(samp.pct3,size.nbinom3,prob.nbinom3), y=sort(rich_fenced_06$Richness_change_pos), xlab = 'Theoretical quantiles', ylab = 'Empirical quantiles', main='Q-Q plot Negative Binomial')
abline(0,1,col="red")
#good

#fit the model
rich_06_nb=glm.nb(Richness_change_pos~Treatment, rich_fenced_06)
summary(rich_06_nb)
#goodness of fit
qchisq(0.95,62)
#Adequate
```

# H: Removal of Browsing will cause Species richness to be higher across all treatments (T1 & T2)
## Visualisation
```{r}
#Year 0 to 3
rich_03_df=rich_df[rich_df$Time=="0-3",]
plot(rich_03_df$Richness_change, xlab="32 quadrats for each plot: 7, 9, 10, 12", ylab="change in species richness", main="Change in species richness in fenced and unfenced quadrats from Y0 to Y3 ", col=factor(rich_03_df$Quadrat_fenced))
abline(h=0, lty=2)
legend("bottomright", legend = paste(c("unfenced","fenced")), col=c("black","red"), pch=1)

boxplot(rich_03_df$Richness_change~rich_03_df$Quadrat_fenced, xlab="Fenced quadrat?", ylab="Change in species richness", main="Change in species richness from Y0 to Y3")

library(ggplot2)
ggplot(rich_03_df, aes(x=Richness_change, color=Quadrat_fenced)) + geom_histogram(fill="white", position="dodge") + theme(legend.position="top")

#Year 3 to 6
rich_36_df=rich_df[rich_df$Time=="3-6",]
plot(rich_36_df$Richness_change, xlab="32 quadrats for each plot: 7, 9, 10, 12", ylab="change in species richness", main="Change in species richness in fenced and unfenced quadrats from Y3 to Y6 ", col=factor(rich_36_df$Quadrat_fenced))
abline(h=0, lty=2)
legend("bottomright", legend = paste(c("unfenced","fenced")), col=c("black","red"), pch=1)

boxplot(rich_36_df$Richness_change~rich_36_df$Quadrat_fenced, xlab="Fenced quadrat?", ylab="Change in species richness", main="Change in species richness from Y3 to Y6")

ggplot(rich_36_df, aes(x=Richness_change, color=Quadrat_fenced)) + geom_histogram(fill="white", position="dodge") + theme(legend.position="top")

#Year 0 to 6
rich_06_df=rich_df[rich_df$Time=="0-6",]
plot(rich_06_df$Richness_change, xlab="32 quadrats for each plot: 7, 9, 10, 12", ylab="change in species richness", main="Change in species richness in fenced and unfenced quadrats from Y0 to Y6 ", col=factor(rich_06_df$Quadrat_fenced))
abline(h=0, lty=2)
legend("bottomright", legend = paste(c("unfenced","fenced")), col=c("black","red"), pch=1)

boxplot(rich_06_df$Richness_change~rich_06_df$Quadrat_fenced, xlab="Fenced quadrat?", ylab="Change in species richness", main="Change in species richness from Y0 to Y6")

ggplot(rich_06_df, aes(x=Richness_change, color=Quadrat_fenced)) + geom_histogram(fill="white", position="dodge") + theme(legend.position="top")
```

## Modelling 

### Y0 to 3 (choose Poisson)
```{r}
# Linear model
rich_03_lm_h2=lm(Richness_change~Quadrat_fenced+Treatment+Quadrat_gap,data=rich_03_df)
summary(rich_03_lm_h2)
plot(rich_03_lm_h2)

rich_03_lm_h2b=lm(Richness_change~Quadrat_fenced+Quadrat_gap,rich_03_df)
summary(rich_03_lm_h2b)
plot(rich_03_lm_h2b)
anova(rich_03_lm_h2b,rich_03_lm_h2)

rich_03_lm_h2c=lm(Richness_change~Quadrat_gap,rich_03_df)
summary(rich_03_lm_h2c)
plot(rich_03_lm_h2c)
anova(rich_03_lm_h2c,rich_03_lm_h2b)

#Quadrat_fenced is not significant
```

```{r}
#Poisson GLM
#manipulate data by adding a constant to every y, so that they are all non-negative
z=min(rich_03_df$Richness_change)
rich_03_df$Richness_change_pos=rich_03_df$Richness_change + abs(z)

#visualisation and test if the data is poisson
hist(rich_03_df$Richness_change_pos)
poisson.model4=fitdist(rich_03_df$Richness_change_pos,"pois",method=c("mle"))
poisson.model4
poisson.lambda4=5.890625

plot(poisson.model4)

n4=length(rich_03_df$Richness_change_pos)
samp.pct4 <- (1:n4-0.5)/n4
qqplot(x=qpois(samp.pct4,poisson.lambda4), y=sort(rich_03_df$Richness_change_pos), xlab = 'Theoretical quantiles', ylab = 'Empirical quantiles', main='Q-Q plot Poisson')
abline(0,1,col="red")

#fit the model
rich_03_pois_h2a=glm(Richness_change_pos~Quadrat_fenced+Treatment+Quadrat_gap, rich_03_df, family = poisson)
summary(rich_03_pois_h2a)
#goodness of fit
qchisq(0.95,124)
#adequate
P__disp(rich_03_pois_h2a)

rich_03_pois_h2b=glm(Richness_change_pos~Quadrat_fenced+Quadrat_gap, rich_03_df, family = poisson)
summary(rich_03_pois_h2b) #choose this
#goodness of fit
qchisq(0.95,125)
#adequate

rich_03_pois_h2c=glm(Richness_change_pos~Quadrat_gap, rich_03_df, family = poisson)
summary(rich_03_pois_h2c)
#goodness of fit
qchisq(0.95,125)

anova(rich_03_pois_h2c,rich_03_pois_h2b)
qchisq(0.95,1)
# Quadrat_fenced is not significant
```

```{r}
#Negative Binomial GLM
#Test if the data is Negative Binomial 
nbinom.model4=fitdist(rich_03_df$Richness_change_pos,"nbinom",method=c("mle"))
nbinom.model4
size.nbinom4=2.783539e+07			#first parameter	
mu.nbinom4=5.890753e+00
prob.nbinom4=size.nbinom4/(size.nbinom4+mu.nbinom4) 
prob.nbinom4

plot(nbinom.model4)
qqplot(x=qnbinom(samp.pct4,size.nbinom4,prob.nbinom4), y=sort(rich_03_df$Richness_change_pos), xlab = 'Theoretical quantiles', ylab = 'Empirical quantiles', main='Q-Q plot Negative Binomial')
abline(0,1,col="red")
#look ok

#fit the model
rich_03_nb_h2a=glm.nb(Richness_change_pos~Quadrat_fenced+Treatment+Quadrat_gap, rich_03_df)
summary(rich_03_nb_h2a)
#goodness of fit
qchisq(0.95,124)
#Adequate

rich_03_nb_h2b=glm.nb(Richness_change_pos~Quadrat_fenced+Quadrat_gap, rich_03_df)
summary(rich_03_nb_h2b) #choose this
#goodness of fit
qchisq(0.95,125)
#Adequate

rich_03_nb_h2c=glm.nb(Richness_change_pos~Quadrat_gap, rich_03_df)
summary(rich_03_nb_h2c)
#goodness of fit
qchisq(0.95,126)
#Adequate
anova(rich_03_nb_h2c,rich_03_nb_h2b)

#Quadrat_fenced is not significant
```

### Y3 to 6 (Choose Poisson)
```{r}
# Linear model
rich_36_lm_h2=lm(Richness_change~Quadrat_fenced+Treatment+Quadrat_gap,data=rich_36_df)
summary(rich_36_lm_h2)
plot(rich_36_lm_h2)

rich_36_lm_h2b=lm(Richness_change~Quadrat_fenced+Quadrat_gap,rich_36_df)
summary(rich_36_lm_h2b)
plot(rich_36_lm_h2b)
anova(rich_36_lm_h2b,rich_36_lm_h2)

rich_36_lm_h2c=lm(Richness_change~Quadrat_gap,rich_36_df)
summary(rich_36_lm_h2c)
plot(rich_36_lm_h2c)
anova(rich_36_lm_h2c,rich_36_lm_h2b)

#Quadrat_fenced is not significant
```

```{r}
#Poisson GLM
#manipulate data by adding a constant to every y, so that they are all non-negative
w=min(rich_36_df$Richness_change)
rich_36_df$Richness_change_pos=rich_36_df$Richness_change + abs(w)

#visualisation and test if the data is poisson
hist(rich_36_df$Richness_change_pos)
poisson.model5=fitdist(rich_36_df$Richness_change_pos,"pois",method=c("mle"))
poisson.model5
poisson.lambda5=7

plot(poisson.model5)

n5=length(rich_36_df$Richness_change_pos)
samp.pct5 <- (1:n5-0.5)/n5
qqplot(x=qpois(samp.pct5,poisson.lambda5), y=sort(rich_36_df$Richness_change_pos), xlab = 'Theoretical quantiles', ylab = 'Empirical quantiles', main='Q-Q plot Poisson')
abline(0,1,col="red")

#fit the model
rich_36_pois_h2a=glm(Richness_change_pos~Quadrat_fenced+Treatment+Quadrat_gap, rich_36_df, family = poisson)
summary(rich_36_pois_h2a)
#goodness of fit
qchisq(0.95,124)
#adequate
P__disp(rich_36_pois_h2a)

rich_36_pois_h2b=glm(Richness_change_pos~Quadrat_fenced+Quadrat_gap, rich_36_df, family = poisson)
summary(rich_36_pois_h2b) #choose this
#goodness of fit
qchisq(0.95,125)
#adequate

rich_36_pois_h2c=glm(Richness_change_pos~Quadrat_gap, rich_36_df, family = poisson)
summary(rich_36_pois_h2c)
#goodness of fit
qchisq(0.95,125)
#adequate

anova(rich_36_pois_h2c,rich_36_pois_h2b)
qchisq(0.95,1)
# Quadrat_fenced is significant!!
```

```{r}
#Negative Binomial GLM
#Test if the data is Negative Binomial 
nbinom.model5=fitdist(rich_36_df$Richness_change_pos,"nbinom",method=c("mle"))
nbinom.model5
size.nbinom5=67.252095			#first parameter	
mu.nbinom5=7.000171
prob.nbinom5=size.nbinom5/(size.nbinom5+mu.nbinom5) 
prob.nbinom5

plot(nbinom.model5)
qqplot(x=qnbinom(samp.pct5,size.nbinom5,prob.nbinom5), y=sort(rich_36_df$Richness_change_pos), xlab = 'Theoretical quantiles', ylab = 'Empirical quantiles', main='Q-Q plot Negative Binomial')
abline(0,1,col="red")
#look good

#fit the model
rich_36_nb_h2a=glm.nb(Richness_change_pos~Quadrat_fenced+Treatment+Quadrat_gap, rich_36_df)
summary(rich_36_nb_h2a)
#goodness of fit
qchisq(0.95,124)
#Adequate

rich_36_nb_h2b=glm.nb(Richness_change_pos~Quadrat_fenced+Quadrat_gap, rich_36_df)
summary(rich_36_nb_h2b) #choose this
#goodness of fit
qchisq(0.95,125)
#Adequate

rich_36_nb_h2c=glm.nb(Richness_change_pos~Quadrat_gap, rich_36_df)
summary(rich_36_nb_h2c)
#goodness of fit
qchisq(0.95,126)
#Adequate
anova(rich_36_nb_h2c,rich_36_nb_h2b)

#Quadrat_fenced is significant!!
```

### Y0 to 6 (Choose negative Binomial model)
```{r}
# Linear model
rich_06_lm_h2=lm(Richness_change~Quadrat_fenced+Treatment+Quadrat_gap,data=rich_06_df)
summary(rich_06_lm_h2)
plot(rich_06_lm_h2)

rich_06_lm_h2b=lm(Richness_change~Quadrat_fenced+Treatment,rich_06_df)
summary(rich_06_lm_h2b)
plot(rich_06_lm_h2b)
anova(rich_06_lm_h2b,rich_06_lm_h2)

rich_06_lm_h2c=lm(Richness_change~Treatment,rich_06_df)
summary(rich_06_lm_h2c)
plot(rich_06_lm_h2c)
anova(rich_06_lm_h2c,rich_06_lm_h2b)

#Quadrat_fenced is not significant
```

```{r}
#Poisson GLM
#manipulate data by adding a constant to every y, so that they are all non-negative
q=min(rich_06_df$Richness_change)
rich_06_df$Richness_change_pos=rich_06_df$Richness_change + abs(q)

#visualisation and test if the data is poisson
hist(rich_06_df$Richness_change_pos)
poisson.model6=fitdist(rich_06_df$Richness_change_pos,"pois",method=c("mle"))
poisson.model6
poisson.lambda6=5.890625	

plot(poisson.model6)

n6=length(rich_06_df$Richness_change_pos)
samp.pct6 <- (1:n6-0.5)/n6
qqplot(x=qpois(samp.pct6,poisson.lambda6), y=sort(rich_06_df$Richness_change_pos), xlab = 'Theoretical quantiles', ylab = 'Empirical quantiles', main='Q-Q plot Poisson')
abline(0,1,col="red")
#looking ok

#fit the model
rich_06_pois_h2a=glm(Richness_change_pos~Quadrat_fenced+Treatment+Quadrat_gap, rich_06_df, family = poisson)
summary(rich_06_pois_h2a)
#goodness of fit
qchisq(0.95,124)
#not adequate
P__disp(rich_36_pois_h2a)

rich_06_pois_h2b=glm(Richness_change_pos~Quadrat_fenced+Treatment, rich_06_df, family = poisson)
summary(rich_06_pois_h2b) 
#goodness of fit
qchisq(0.95,125)
#not adequate

rich_06_pois_h2c=glm(Richness_change_pos~Treatment, rich_06_df, family = poisson)
summary(rich_06_pois_h2c)
#goodness of fit
qchisq(0.95,126)
#not adequate

anova(rich_06_pois_h2c,rich_06_pois_h2b)
qchisq(0.95,1)
# None of the models are adequate
# Quadrat_fenced is not significant
```

```{r}
#Negative Binomial GLM
#Test if the data is Negative Binomial 
nbinom.model6=fitdist(rich_06_df$Richness_change_pos,"nbinom",method=c("mle"))
nbinom.model6
size.nbinom6=29.318587				#first parameter	
mu.nbinom6=5.890292
prob.nbinom6=size.nbinom6/(size.nbinom6+mu.nbinom6) 
prob.nbinom6

plot(nbinom.model6)
qqplot(x=qnbinom(samp.pct6,size.nbinom6,prob.nbinom6), y=sort(rich_06_df$Richness_change_pos), xlab = 'Theoretical quantiles', ylab = 'Empirical quantiles', main='Q-Q plot Negative Binomial')
abline(0,1,col="red")
#look good

#fit the model
rich_06_nb_h2a=glm.nb(Richness_change_pos~Quadrat_fenced+Treatment+Quadrat_gap, rich_06_df)
summary(rich_06_nb_h2a)
#goodness of fit
qchisq(0.95,124)
#Adequate

rich_06_nb_h2b=glm.nb(Richness_change_pos~Quadrat_fenced+Treatment, rich_06_df)
summary(rich_06_nb_h2b) #choose this
#goodness of fit
qchisq(0.95,125)
#Adequate

rich_06_nb_h2c=glm.nb(Richness_change_pos~Treatment, rich_06_df)
summary(rich_06_nb_h2c)
#goodness of fit
qchisq(0.95,126)
#Adequate
anova(rich_06_nb_h2c,rich_06_nb_h2b)

#Quadrat_fenced is not significant
```

# Species diversity (Shannon's diversity index)
*First idea was to use (num of specific species)/(num of total unique species) but...
* It seems to make more sense(?) if p is calculated by score(species i)/(total score in the quadrat)
reference: http://www.bioline.org.br/pdf?st09043

```{r}
#Calculate Shannon's diversity index

Y0_div=c()
for (i in c(7,9,10,12))
  {for (j in seq(1,32,1))
    {dataset=Y0_data[Y0_data$Plot_number==i & Y0_data$Quadrat_number==j,]
    total_score=sum(dataset$Score)
    p_scientifname <- dataset %>%
    group_by(Scientific.Name) %>%
    summarise(s = sum(Score)) 
    p_scientifname$p=p_scientifname$s/total_score
    a=-sum((p_scientifname$p)*log(p_scientifname$p))
    Y0_div=append(Y0_div,a)
  }
}
Y0_div

Y3_div=c()
for (i in c(7,9,10,12))
  {for (j in seq(1,32,1))
    {dataset=Y3_data[Y3_data$Plot_number==i & Y3_data$Quadrat_number==j,]
    total_score=sum(dataset$Score)
    p_scientifname <- dataset %>%
    group_by(Scientific.Name) %>%
    summarise(s = sum(Score)) 
    p_scientifname$p=p_scientifname$s/total_score
    a=-sum((p_scientifname$p)*log(p_scientifname$p))
    Y3_div=append(Y3_div,a)
  }
}
Y3_div

Y6_div=c()
for (i in c(7,9,10,12))
  {for (j in seq(1,32,1))
    {dataset=Y6_data[Y6_data$Plot_number==i & Y6_data$Quadrat_number==j,]
    total_score=sum(dataset$Score)
    p_scientifname <- dataset %>%
    group_by(Scientific.Name) %>%
    summarise(s = sum(Score)) 
    p_scientifname$p=p_scientifname$s/total_score
    a=-sum((p_scientifname$p)*log(p_scientifname$p))
    Y6_div=append(Y6_div,a)
  }
}
Y6_div

# Calculate changes in species diversity
Y03_div=Y3_div-Y0_div
Y03_div

Y36_div=Y6_div-Y3_div
Y36_div

Y06_div=Y6_div-Y0_div
Y06_div

#Generate a dataframe for the changes in species diversity
Diversity_change=c(Y03_div,Y36_div,Y06_div)
div_df=data.frame(Time, Plot_number, Treatment, Quadrat_number, Quadrat_fenced, Quadrat_gap, Diversity_change)

# Calculate percentage change in species diversity (to be used in Beta GLM later)
Y03_divpc=Y03_div/Y0_div
Y03_divpc

Y36_divpc=Y36_div/Y3_div
Y36_divpc

Y06_divpc=Y06_div/Y0_div
Y06_divpc

div_df$Diversity_pcchange=c(Y03_divpc,Y36_divpc,Y06_divpc)
```

# H: Removal of browsing will cause a greater increase in understorey species diversity in T1 as compared to T2 
## Visualisation
```{r}
#Year 0 to 3
div_fenced_03=div_df[div_df$Time=="0-3" & Quadrat_fenced=="True",]
plot(div_fenced_03$Diversity_change, xlab="16 fenced quadrats for each plot: 7, 9, 10, 12", ylab="change in species diversity", main="Change in species diversity from Y0 to Y3 after browsing exclusion", col=factor(div_fenced_03$Treatment))
abline(h=0, lty=2)
legend("bottomright", legend = paste(c("T1","T2")), col=c("black","red"), pch=1)

boxplot(div_fenced_03$Diversity_change~div_fenced_03$Treatment, xlab="Treatment", ylab="Change in species diversity", main="Change in species diversity from Y0 to Y3 after browsing exclusion")

plot(density(div_fenced_03$Diversity_change), main = "Probability density of the change in species diversity from Y0 to Y3", xlab="Change in species diversity")

#Year 3 to 6
div_fenced_36=div_df[div_df$Time=="3-6" & Quadrat_fenced=="True",]
plot(div_fenced_36$Diversity_change, xlab="16 fenced quadrats for each plot: 7, 9, 10, 12", ylab="change in species diversity", main="Change in species diversity from Y3 to Y6 after browsing exclusion", col=factor(div_fenced_36$Treatment))
abline(h=0, lty=2)
legend("bottomright", legend = paste(c("T1","T2")), col=c("black","red"), pch=1)

boxplot(div_fenced_36$Diversity_change~div_fenced_36$Treatment, xlab="Treatment", ylab="Change in species diversity", main="Change in species diversity from Y3 to Y6 after browsing exclusion")

plot(density(div_fenced_36$Diversity_change), main = "Probability density of the change in species diversity from Y3 to Y6", xlab="Change in species diversity")

#Year 0 to 6
div_fenced_06=div_df[div_df$Time=="0-6" & Quadrat_fenced=="True",]
plot(div_fenced_06$Diversity_change, xlab="16 fenced quadrats for each plot: 7, 9, 10, 12", ylab="change in species diversity", main="Change in species diversity from Y0 to Y6 after browsing exclusion", col=factor(div_fenced_06$Treatment))
abline(h=0, lty=2)
legend("bottomright", legend = paste(c("T1","T2")), col=c("black","red"), pch=1)

boxplot(div_fenced_06$Diversity_change~div_fenced_06$Treatment, xlab="Treatment", ylab="Change in species diversity", main="Change in species diversity from Y0 to Y6 after browsing exclusion")

plot(density(div_fenced_06$Diversity_change), main = "Probability density of the change in species diversity from Y0 to Y6", xlab="Change in species diversity")
```

## Modelling
### Year 0 to 3 (Choose linear model)
```{r}
# Linear model
div_03_lm=lm(Diversity_change~Treatment, div_fenced_03)
summary(div_03_lm)
plot(div_03_lm)
div_03_lm2=lm(Diversity_change~1, div_fenced_03)
anova(div_03_lm2,div_03_lm)
#intercept only model is better
```

```{r}
# Gamma and Inverse Gaussian GLM
#manipulate data by adding a constant to every y, so that they are all positive
d=min(div_fenced_03$Diversity_change)-0.0001 #-0.0001 so that y is not 0 
div_fenced_03$Diversity_change_pos=div_fenced_03$Diversity_change + abs(d)

#visualisation and test if the data is gamma or inverse Gaussian
plot(density(div_fenced_03$Diversity_change_pos))
#Unlikely to be gamma cause it's not positively skewed
gamma.model=fitdist(div_fenced_03$Diversity_change_pos,"gamma",method=c("mle"))
gamma.model
plot(gamma.model)
#looking terrible

library(statmod)
library(GeneralizedHyperbolic)
invgstrt <- nigFitStart(div_fenced_03$Diversity_change_pos, startValues = "FN")
invgstrt$paramStart
invg.model=fitdist(div_fenced_03$Diversity_change_pos,"invgauss",start = list(mean=0.69055512, dispersion=0.34918280, shape=1))
invg.model
plot(invg.model)
#looking terrible


#fit the model (Gamma)
div_03_gamma=glm(Diversity_change_pos~Treatment, div_fenced_03, family = Gamma)
summary(div_03_gamma)
#goodness of fit
qchisq(0.95,62)
#adequate but bad fit (?)

#So, choose linear model
```

```{r}
#Beta GLM (might try, but needs y to be b/w 0 and 1, so need percentage change) (tbc)
beta.model=fitdist(div_fenced_03$Diversity_change_pos,"beta",method=c("mle"))
beta.model
plot(beta.model)
```

### Year 3 to 6 (Choose linear model)
```{r}
# Linear model
div_36_lm=lm(Diversity_change~Treatment, div_fenced_36)
summary(div_36_lm)
plot(div_36_lm)

div_36_lm2=lm(Diversity_change~1, div_fenced_36)
anova(div_36_lm2,div_36_lm)
#intercept only model is better
```

```{r}
# Gamma GLM
#manipulate data by adding a constant to every y, so that they are all positive
e=min(div_fenced_36$Diversity_change)-0.0001 #-0.0001 so that y is not 0 
div_fenced_36$Diversity_change_pos=div_fenced_36$Diversity_change + abs(e)

#visualisation and test if the data is gamma
plot(density(div_fenced_36$Diversity_change_pos))

gamma.model2=fitdist(div_fenced_36$Diversity_change_pos,"gamma",method=c("mle"))
gamma.model2
plot(gamma.model2)
#looking quite bad

#fit the model (Gamma)
div_36_gamma=glm(Diversity_change_pos~Treatment, div_fenced_36, family = Gamma)
plot(div_36_gamma)
summary(div_36_gamma)
#goodness of fit
qchisq(0.95,62)
#adequate 
```

```{r}
# Inverse Gaussian GLM
invgstrt <- nigFitStart(div_fenced_36$Diversity_change_pos, startValues = "FN")
invgstrt$paramStart
invg.model2=fitdist(div_fenced_36$Diversity_change_pos,"invgauss",start = list(mean=1.0335212, dispersion=0.4779232, shape=1))
invg.model2
plot(invg.model2)
#looking terrible
```

```{r}
# Beta GLM
# manipulate data by adding a constant to every y, so that they are all non-negative 
e2=min(div_fenced_36$Diversity_pcchange)-0.00001 
div_fenced_36$Diversity_pcchange_pos=div_fenced_36$Diversity_pcchange + abs(e2)
length(div_fenced_36[div_fenced_36$Diversity_pcchange_pos>1]) #1 value is greater than 1

div_36_beta=glm(Diversity_pcchange_pos~Treatment, div_fenced_36, family = Beta)
#error, can't fit the model
```

### Year 0 to 6 (Choose linear model)
```{r}
# Linear model
div_06_lm=lm(Diversity_change~Treatment, div_fenced_06)
summary(div_06_lm)
plot(div_06_lm)
div_06_lm2=lm(Diversity_change~1, div_fenced_06)
anova(div_06_lm2,div_06_lm)
#intercept only model is better
```

```{r}
# Gamma GLM
#manipulate data by adding a constant to every y, so that they are all positive
f=min(div_fenced_06$Diversity_change)-0.000001 #-0.0001 so that y is not 0 
div_fenced_06$Diversity_change_pos=div_fenced_06$Diversity_change + abs(f)

#visualisation and test if the data is gamma
plot(density(div_fenced_06$Diversity_change_pos))

gamma.model3=fitdist(div_fenced_06$Diversity_change_pos,"gamma",method=c("mle"))
gamma.model3
plot(gamma.model3)
#looking quite bad 

#fit the model (Gamma)
div_06_gamma=glm(Diversity_change_pos~Treatment, div_fenced_06, family = Gamma)
summary(div_06_gamma)
#goodness of fit
qchisq(0.95,62)
#adequate 
```

```{r}
# Inverse Gaussian GLM
invgstrt <- nigFitStart(div_fenced_06$Diversity_change_pos, startValues = "FN")
invgstrt$paramStart
invg.model3=fitdist(div_fenced_36$Diversity_change_pos,"invgauss",start = list(mean=0.9958723, dispersion=0.4925091, shape=1))
invg.model3
plot(invg.model3)
#looking terrible
```

# H: Removal of Browsing will cause Species diversity to be higher across all treatments (T1 & T2)
## Visualisation
```{r}
#Year 0 to 3
div_03_df=div_df[div_df$Time=="0-3",]
plot(div_03_df$Diversity_change, xlab="32 quadrats for each plot: 7, 9, 10, 12", ylab="change in species diversity", main="Change in species diversity in fenced and unfenced quadrats from Y0 to Y3 ", col=factor(div_03_df$Quadrat_fenced))
abline(h=0, lty=2)
legend("bottomright", legend = paste(c("unfenced","fenced")), col=c("black","red"), pch=1)

boxplot(div_03_df$Diversity_change~div_03_df$Quadrat_fenced, xlab="Fenced quadrat?", ylab="Change in species diversity", main="Change in species diversity from Y0 to Y3")

library(ggplot2)
ggplot(div_03_df, aes(x=Diversity_change, color=Quadrat_fenced)) + geom_histogram(fill="white", position="dodge") + theme(legend.position="top")

#Year 3 to 6
div_36_df=div_df[div_df$Time=="3-6",]
plot(div_36_df$Diversity_change, xlab="32 quadrats for each plot: 7, 9, 10, 12", ylab="change in species diversity", main="Change in species diversity in fenced and unfenced quadrats from Y3 to Y6 ", col=factor(div_36_df$Quadrat_fenced))
abline(h=0, lty=2)
legend("bottomright", legend = paste(c("unfenced","fenced")), col=c("black","red"), pch=1)

boxplot(div_36_df$Diversity_change~div_36_df$Quadrat_fenced, xlab="Fenced quadrat?", ylab="Change in species diversity", main="Change in species diversity from Y3 to Y6")

ggplot(div_36_df, aes(x=Diversity_change, color=Quadrat_fenced)) + geom_histogram(fill="white", position="dodge") + theme(legend.position="top")

#Year 0 to 6
div_06_df=div_df[div_df$Time=="0-6",]
plot(div_06_df$Diversity_change, xlab="32 quadrats for each plot: 7, 9, 10, 12", ylab="change in species diversity", main="Change in species diversity in fenced and unfenced quadrats from Y0 to Y6 ", col=factor(div_06_df$Quadrat_fenced))
abline(h=0, lty=2)
legend("bottomright", legend = paste(c("unfenced","fenced")), col=c("black","red"), pch=1)

boxplot(div_06_df$Diversity_change~div_06_df$Quadrat_fenced, xlab="Fenced quadrat?", ylab="Change in species diversity", main="Change in species diversity from Y0 to Y6")

ggplot(div_06_df, aes(x=Diversity_change, color=Quadrat_fenced)) + geom_histogram(fill="white", position="dodge") + theme(legend.position="top")
```

## Modelling
### Year 0 to 3 (Choose Linear model)
```{r}
# Linear model
div_03_lm_h2a=lm(Diversity_change~Quadrat_fenced+Treatment+Quadrat_gap, div_03_df)
summary(div_03_lm_h2a)
plot(div_03_lm_h2a)

div_03_lm_h2b=lm(Diversity_change~Quadrat_fenced+Quadrat_gap, div_03_df)
summary(div_03_lm_h2b)
plot(div_03_lm_h2b)
AIC(div_03_lm_h2b)

div_03_lm_h2c=lm(Diversity_change~Quadrat_gap, div_03_df)
summary(div_03_lm_h2c)
plot(div_03_lm_h2c)
anova(div_03_lm_h2c,div_03_lm_h2b)
#Quadrat_fenced is not significant (but nearly significant)
```

```{r}
# Gamma GLM
#manipulate data by adding a constant to every y, so that they are all positive
t=min(div_03_df$Diversity_change)-0.0001 #-0.0001 so that y is not 0 
div_03_df$Diversity_change_pos=div_03_df$Diversity_change + abs(t)

#visualisation and test if the data is gamma or inverse Gaussian
plot(density(div_03_df$Diversity_change_pos))
#Unlikely to be gamma cause it's not positively skewed
gamma.model4=fitdist(div_03_df$Diversity_change_pos,"gamma",method=c("mle"))
gamma.model4
plot(gamma.model4)
#looking worse than linear model

#fit the model (Gamma)
div_03_gamma_h2a=glm(Diversity_change_pos~Quadrat_fenced+Treatment+Quadrat_gap, div_03_df, family = Gamma)
summary(div_03_gamma_h2a)
#goodness of fit
qchisq(0.95,124)
#adequate

div_03_gamma_h2b=glm(Diversity_change_pos~Quadrat_fenced+Quadrat_gap, div_03_df, family = Gamma)
summary(div_03_gamma_h2b)
#goodness of fit
qchisq(0.95,125)
#adequate
plot(div_03_gamma_h2b)

div_03_gamma_h2c=glm(Diversity_change_pos~Quadrat_gap, div_03_df, family = Gamma)
summary(div_03_gamma_h2c)
#goodness of fit
qchisq(0.95,126)
#adequate

anova(div_03_gamma_h2c,div_03_gamma_h2b)
#Quadrat_gap not significant
```

### Year 3 to 6 (Choose Linear model) 
```{r}
# Linear model
div_36_lm_h2a=lm(Diversity_change~Quadrat_fenced+Treatment+Quadrat_gap, div_36_df)
summary(div_36_lm_h2a)
plot(div_36_lm_h2a)

div_36_lm_h2b=lm(Diversity_change~Quadrat_fenced+Quadrat_gap, div_36_df)
summary(div_36_lm_h2b)
plot(div_36_lm_h2b)
AIC(div_36_lm_h2b)

div_36_lm_h2c=lm(Diversity_change~Quadrat_gap, div_36_df)
summary(div_36_lm_h2c)
plot(div_36_lm_h2c)
anova(div_36_lm_h2c,div_36_lm_h2b)
#Quadrat_fenced is very significant
```

```{r}
# Gamma GLM
#manipulate data by adding a constant to every y, so that they are all positive
s=min(div_36_df$Diversity_change)-0.0001 #-0.0001 so that y is not 0 
div_36_df$Diversity_change_pos=div_36_df$Diversity_change + abs(s)

#visualisation and test if the data is gamma
plot(density(div_36_df$Diversity_change_pos))
#Unlikely to be gamma cause it's not positively skewed
gamma.model5=fitdist(div_36_df$Diversity_change_pos,"gamma",method=c("mle"))
gamma.model5
plot(gamma.model5)
#looking worse than linear model

#fit the model (Gamma)
div_36_gamma_h2a=glm(Diversity_change_pos~Quadrat_fenced+Treatment+Quadrat_gap, div_36_df, family = Gamma)
summary(div_36_gamma_h2a)
#goodness of fit
qchisq(0.95,124)
#adequate

div_36_gamma_h2b=glm(Diversity_change_pos~Quadrat_fenced+Quadrat_gap, div_36_df, family = Gamma)
summary(div_36_gamma_h2b)
#goodness of fit
qchisq(0.95,125)
#adequate
plot(div_36_gamma_h2b)

div_36_gamma_h2c=glm(Diversity_change_pos~Quadrat_gap, div_36_df, family = Gamma)
summary(div_36_gamma_h2c)
#goodness of fit
qchisq(0.95,126)
#adequate

anova(div_36_gamma_h2c,div_36_gamma_h2b)
qchisq(0.95,1)
#Quadrat_gap not significant
```

### Year 0 to 6 (Choose Linear model)
```{r}
# Linear model
div_06_lm_h2a=lm(Diversity_change~Quadrat_fenced+Treatment+Quadrat_gap, div_06_df)
summary(div_06_lm_h2a)
plot(div_06_lm_h2a)

div_06_lm_h2b=lm(Diversity_change~Quadrat_fenced+Quadrat_gap, div_06_df)
summary(div_06_lm_h2b)
plot(div_06_lm_h2b)
AIC(div_06_lm_h2b)

div_06_lm_h2c=lm(Diversity_change~Quadrat_gap, div_06_df)
summary(div_06_lm_h2c)
plot(div_06_lm_h2c)
anova(div_06_lm_h2c,div_06_lm_h2b)
#Quadrat_fenced is not significant (but nearly)
```

```{r}
# Gamma GLM
#manipulate data by adding a constant to every y, so that they are all positive
r=min(div_06_df$Diversity_change)-0.0001 #-0.0001 so that y is not 0 
div_06_df$Diversity_change_pos=div_06_df$Diversity_change + abs(r)

#visualisation and test if the data is gamma
plot(density(div_06_df$Diversity_change_pos))
gamma.model6=fitdist(div_06_df$Diversity_change_pos,"gamma",method=c("mle"))
gamma.model6
plot(gamma.model6)
#looking worse than linear model

#fit the model (Gamma)
div_06_gamma_h2a=glm(Diversity_change_pos~Quadrat_fenced+Treatment+Quadrat_gap, div_06_df, family = Gamma)
summary(div_06_gamma_h2a)
#goodness of fit
qchisq(0.95,124)
#adequate

div_06_gamma_h2b=glm(Diversity_change_pos~Quadrat_fenced+Quadrat_gap, div_06_df, family = Gamma)
summary(div_06_gamma_h2b)
#goodness of fit
qchisq(0.95,125)
#adequate
plot(div_06_gamma_h2b)

div_06_gamma_h2c=glm(Diversity_change_pos~Quadrat_gap, div_06_df, family = Gamma)
summary(div_06_gamma_h2c)
#goodness of fit
qchisq(0.95,126)
#adequate

anova(div_06_gamma_h2c,div_06_gamma_h2b)
qchisq(0.95,1)
#Quadrat_gap not significant
```
